<!doctype html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

  <title>x-router test</title>

  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../web-component-tester/browser.js"></script>

  <link rel="import" href="../x-router.html">

</head>

<body>

  <test-fixture id="element">
    <template>
      <x-router>
        <x-path name="home" pattern="^/$"></x-path>
        <x-path name="signup" pattern="^/signup$"></x-path>
        <x-path name="schedule" pattern="^/schedule$"></x-path>
        <x-path name="info" pattern="^/info$"></x-path>
      </x-router>
    </template>
  </test-fixture>

  <script>

      suite('x-router', function () {
        
        let element;
        setup(function () {
          element = fixture('element');
        });

        test('instantiating the element works', function () {
          assert.equal(element.is, 'x-router');
        });

        suite('finds all children', function () {

          test('length of children is 4', function () {
            let children = element._getRouteChildren();
            assert.equal(children.length, 4);
          });

          test('second child is singup', function () {
            let children = element._getRouteChildren();
            assert.equal(children[1].getAttribute('name'), 'signup');
          });

        });

        suite('query string to object', function () {

          test('two query parameter works', function () {
            let search = 'firstName=James&lastName=Bond';
            let object = element._queryStringToObject(search);
            assert.equal(object.firstName, 'James');
            assert.equal(object.lastName, 'Bond');
          });

          test('special character works', function () {
            let search = 'firstName=Göran';
            let object = element._queryStringToObject(search);
            assert.equal(object.firstName, 'Göran');
          });

          test('url encoded character works', function () {
            let search = 'firstName=James%20Bond';
            let object = element._queryStringToObject(search);
            assert.equal(object.firstName, 'James Bond');
          });

          test('empty string returns undefined variable', function () {
            let search = '';
            let object = element._queryStringToObject(search);
            assert.equal(object.firstName, undefined);
          });

        });

        suite('find child name for path', function () {

          test('finds "home"', function () {
            let name = element._findChildNameForPath(element.children, '/');
            assert.equal(name, 'home');
          });

          test('finds "signup"', function () {
            let name = element._findChildNameForPath(element.children, '/signup');
            assert.equal(name, 'signup');
          });

          test('finds "schedule"', function () {
            let name = element._findChildNameForPath(element.children, '/schedule');
            assert.equal(name, 'schedule');
          });

          test('finds "info"', function () {
            let name = element._findChildNameForPath(element.children, '/info');
            assert.equal(name, 'info');
          });

          test('does not find "unknown"', function () {
            let name = element._findChildNameForPath(element.children, '/unknown');
            assert.equal(name, null);
          });

        });

        suite('split path name', function () {

          test('splits "/" correctly', function () {
            let paths = element._splitPathname('/');
            assert.equal(paths[0], '/');
          });

          test('splits longer path correctly', function () {
            let paths = element._splitPathname('/one/two/three');
            assert.equal(paths[0], '/one');
            assert.equal(paths[1], '/two');
            assert.equal(paths[2], '/three');
          });

          test('has correct length of paths array', function () {
            let paths = element._splitPathname('/one/two/three');
            assert.equal(paths.length, 3);
          });

        });

        suite('current path name from paths', function () {

          test('change first route', function () {
            const paths = ['/one', '/two', 'three'];
            const pathName = ['/myRoute'];
            const index = 0;
            let newPathName = element._currentPathnameFromPaths(paths, pathName, index);
            assert.equal(newPathName, '/myRoute');
          });

          test('change second route', function () {
            const paths = ['/one', '/two', 'three'];
            const pathName = ['/myRoute'];
            const index = 1;
            let newPathName = element._currentPathnameFromPaths(paths, pathName, index);
            assert.equal(newPathName, '/one/myRoute');
          });

          test('change third route', function () {
            const paths = ['/one', '/two', 'three'];
            const pathName = ['/myRoute'];
            const index = 2;
            let newPathName = element._currentPathnameFromPaths(paths, pathName, index);
            assert.equal(newPathName, '/one/two/myRoute');
          });

          test('change route out of index', function () {
            const paths = ['/one', '/two', 'three'];
            const pathName = ['/myRoute'];
            const index = 3;
            let newPathName = element._currentPathnameFromPaths(paths, pathName, index);
            assert.equal(newPathName, null);
          });

        });

        suite('location pathname', function () {

          test('returns mock location pathname if defined', function () {
            element._mockLocationPathname = '/myMockPathname';
            assert.equal(element._locationPathName(), '/myMockPathname');
          });

          test('returns window location pathname when mock location is NOT defined', function () {
            assert.equal(element._locationPathName(), window.location.pathname);
          });

        });

        suite('location search', function () {

          test('returns mock location search if defined', function () {
            element._mockLocationSearch = '?firstName=John';
            assert.equal(element._locationSearch(), 'firstName=John');
          });

          test('returns window location search when mock location is NOT defined', function () {
            assert.equal(element._locationSearch(), window.location.search.substring(1));
          });

        });

        suite('location hash', function () {

          test('returns mock location hash if defined', function () {
            element._mockLocationHash = '#hash';
            assert.equal(element._locationHash(), 'hash');
          });

          test('returns window location hash when mock location is NOT defined', function () {
            assert.equal(element._locationHash(), window.location.hash.substring(1));
          });

        });

        suite('route-change event', function () {

          test('dispatch an event', function (done) {
            element.addEventListener('route-change', (event) => {
              done();
            });
            element.push('/signup', null);
          });

          test('returns correct name in event', function (done) {
            element.addEventListener('route-change', (event) => {
              assert.equal(event.detail.name, 'signup');
              done();
            });
            element.push('/signup', null);
          });

          test('returns correct current pathname in event', function (done) {
            element.addEventListener('route-change', (event) => {
              assert.equal(event.detail.currentPathname, '/category');
              done();
            });
            element.push('/category/shoes', null);
          });

          test('returns correct pathname in event', function (done) {
            element.addEventListener('route-change', (event) => {
              assert.equal(event.detail.pathname, '/category/shoes');
              done();
            });
            element.push('/category/shoes', null);
          });

          test('returns correct parent pathname in event', function (done) {
            element.addEventListener('route-change', (event) => {
              assert.equal(event.detail.parentPathname, '');
              done();
            });
            element.push('/category/shoes', null);
          });

          test('returns correct name in event', function (done) {
            element.addEventListener('route-change', (event) => {
              assert.equal(event.detail.hash, 'hash');
              done();
            });
            element._mockLocationHash = '#hash';
            element.push('/', null);
          });

          test('returns correct query object in event', function (done) {
            element.addEventListener('route-change', (event) => {
              assert.equal(event.detail.queryObject.firstName, 'John');
              done();
            });
            element._mockLocationSearch = '?firstName=John';
            element.push('/', null);
          });

        });

      });

    </script>

</body>

</html>